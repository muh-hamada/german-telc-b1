rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // App Remote Configuration Collection
    // All users can read configs, only admin can write
    match /app_configs/{appId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43";
    }

    // B1 German Telc Exam Data Collection
    match /b1_telc_exam_data/{document} {
      allow read: if true
      
      // Only authenticated users can write
      allow write: if request.auth != null && request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43";
    }

    // B2 German Telc Exam Data Collection
    match /german_b2_telc_exam_data/{document} {
      allow read: if true
      
      // Only authenticated users can write
      allow write: if request.auth != null && request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43";
    }

    // English B1 Telc Exam Data Collection
    match /english_b1_telc_exam_data/{document} {
      allow read: if true
      
      // Only authenticated users can write
      allow write: if request.auth != null && request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43";
    }

    // Vocabulary Data Collections
    // All users can read vocabulary, only admin can write
    match /vocabulary_data_german_a1/{wordId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43";
    }

    match /vocabulary_data_german_b2/{wordId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43";
    }

    match /vocabulary_data_english_a1/{wordId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43";
    }
    
    // User progress collection (top-level)
    // Users can only read/write their own progress
    match /progress/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Exam results collection (top-level)
    // Users can only read/write their own exam results
    match /examResults/{document} {
      allow read: if request.auth != null && request.auth.uid == resource.data.uid;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.uid;
    }
    
    // User profiles
    // Users can only read/write their own profile
    // Admin can read all profiles
    match /users/{userId} {
      allow read: if request.auth != null && 
                    (request.auth.uid == userId || 
                     request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43");
      allow write: if request.auth != null && request.auth.uid == userId;
      
      // User progress data (B1 - nested under users)
      match /progress/{document=**} {
        allow read: if request.auth != null && 
                      (request.auth.uid == userId || 
                       request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43");
        allow write: if request.auth != null && request.auth.uid == userId;
      }
      
      // User progress data (B2 - nested under users)
      match /german_b2_progress/{document=**} {
        allow read: if request.auth != null && 
                      (request.auth.uid == userId || 
                       request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43");
        allow write: if request.auth != null && request.auth.uid == userId;
      }
      
      // User exam results (legacy - nested under users)
      match /examResults/{document=**} {
        allow read: if request.auth != null && 
                      (request.auth.uid == userId || 
                       request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43");
        allow write: if request.auth != null && request.auth.uid == userId;
      }
      
      // User completions (B1)
      // Allow users to read/write their own completion data
      // Admin can read all completions
      match /completions/{document=**} {
        allow read: if request.auth != null && 
                      (request.auth.uid == userId || 
                       request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43");
        allow write: if request.auth != null && request.auth.uid == userId;
      }
      
      // User streaks (Daily Streaks feature)
      // Allow users to read/write their own streak data
      // Admin can read all streaks
      match /streaks/{document=**} {
        allow read: if request.auth != null && 
                      (request.auth.uid == userId || 
                       request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43");
        allow write: if request.auth != null && request.auth.uid == userId;
      }

      // User vocabulary progress (German A1)
      match /vocabulary_progress_german_a1/{document=**} {
        allow read: if request.auth != null && 
                      (request.auth.uid == userId || 
                       request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43");
        allow write: if request.auth != null && request.auth.uid == userId;
      }

      // User vocabulary progress (German B2)
      match /vocabulary_progress_german_b2/{document=**} {
        allow read: if request.auth != null && 
                      (request.auth.uid == userId || 
                       request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43");
        allow write: if request.auth != null && request.auth.uid == userId;
      }

      // User vocabulary progress (English A1)
      match /vocabulary_progress_english_a1/{document=**} {
        allow read: if request.auth != null && 
                      (request.auth.uid == userId || 
                       request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43");
        allow write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // Account deletion requests
    // Users can only read and create their own deletion request
    // Admin can read and update all deletion requests
    match /account_deletion_requests/{userId} {
      allow read: if request.auth != null && 
                    (request.auth.uid == userId || 
                     request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43");
      allow create: if request.auth != null 
                    && request.auth.uid == userId
                    && request.auth.uid == request.resource.data.uid
                    && request.resource.data.status == 'pending';
      allow update: if request.auth != null && 
                      request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43";
    }
  }
}

