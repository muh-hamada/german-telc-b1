rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // App Remote Configuration Collection
    // All users can read configs, only admin can write
    match /app_configs/{appId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43";
    }

    // B1 German Telc Exam Data Collection
    match /b1_telc_exam_data/{document} {
      allow read: if true
      
      // Only authenticated users can write
      allow write: if request.auth != null && request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43";
    }

    // B2 German Telc Exam Data Collection
    match /german_b2_telc_exam_data/{document} {
      allow read: if true
      
      // Only authenticated users can write
      allow write: if request.auth != null && request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43";
    }

    // English B1 Telc Exam Data Collection
    match /english_b1_telc_exam_data/{document} {
      allow read: if true
      
      // Only authenticated users can write
      allow write: if request.auth != null && request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43";
    }

    // English B2 Telc Exam Data Collection
    match /english_b2_telc_exam_data/{document} {
      allow read: if true
      
      // Only authenticated users can write
      allow write: if request.auth != null && request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43";
    }

    // German A1 Telc Exam Data Collection
    match /german_a1_telc_exam_data/{document} {
      allow read: if true
      
      // Only authenticated users can write
      allow write: if request.auth != null && request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43";
    }

    // Exam Prep Plan Configurations
    // All authenticated users can read configs, only admin can write
    match /prepPlanConfigs/{configId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43";
    }

    // Vocabulary Data Collections
    // All users can read vocabulary, only admin can write
    match /vocabulary_data_german_a1/{wordId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43";
    }

    match /vocabulary_data_german_b1/{wordId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43";
    }

    match /vocabulary_data_german_b2/{wordId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43";
    }

    match /vocabulary_data_english_b1/{wordId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43";
    }

    match /vocabulary_data_english_b2/{wordId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43";
    }
    
    // User progress collection (top-level)
    // Users can only read/write their own progress
    match /progress/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Exam results collection (top-level)
    // Users can only read/write their own exam results
    match /examResults/{document} {
      allow read: if request.auth != null && request.auth.uid == resource.data.uid;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.uid;
    }
    
    // User profiles
    // Users can only read/write their own profile
    // Admin can read all profiles
    match /users/{userId} {
      allow read: if request.auth != null && 
                    (request.auth.uid == userId || 
                     request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43");
      allow write: if request.auth != null && request.auth.uid == userId;
      
      // User progress data (German B1 - nested under users)
      match /progress/{document=**} {
        allow read: if request.auth != null && 
                      (request.auth.uid == userId || 
                       request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43");
        allow write: if request.auth != null && request.auth.uid == userId;
      }
      
      // User progress data (German A1 - nested under users)
      match /german_a1_progress/{document=**} {
        allow read: if request.auth != null && 
                      (request.auth.uid == userId || 
                       request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43");
        allow write: if request.auth != null && request.auth.uid == userId;
      }
      
      // User progress data (German B2 - nested under users)
      match /german_b2_progress/{document=**} {
        allow read: if request.auth != null && 
                      (request.auth.uid == userId || 
                       request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43");
        allow write: if request.auth != null && request.auth.uid == userId;
      }

      // User progress data (English B1 - nested under users)
      match /english_b1_progress/{document=**} {
        allow read: if request.auth != null && 
                      (request.auth.uid == userId || 
                       request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43");
        allow write: if request.auth != null && request.auth.uid == userId;
      }

      // User progress data (English B2 - nested under users)
      match /english_b2_progress/{document=**} {
        allow read: if request.auth != null && 
                      (request.auth.uid == userId || 
                       request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43");
        allow write: if request.auth != null && request.auth.uid == userId;
      }
      
      // User exam results (legacy - nested under users)
      match /examResults/{document=**} {
        allow read: if request.auth != null && 
                      (request.auth.uid == userId || 
                       request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43");
        allow write: if request.auth != null && request.auth.uid == userId;
      }
      
      // User completions (B1)
      // Allow users to read/write their own completion data
      // Admin can read all completions
      match /completions/{document=**} {
        allow read: if request.auth != null && 
                      (request.auth.uid == userId || 
                       request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43");
        allow write: if request.auth != null && request.auth.uid == userId;
      }
      
      // User completions (German A1)
      match /completions_german_a1/{document=**} {
        allow read: if request.auth != null && 
                      (request.auth.uid == userId || 
                       request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43");
        allow write: if request.auth != null && request.auth.uid == userId;
      }
      
      // User completions (German B2)
      match /completions_german_b2/{document=**} {
        allow read: if request.auth != null && 
                      (request.auth.uid == userId || 
                       request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43");
        allow write: if request.auth != null && request.auth.uid == userId;
      }

      // User completions (English B1)
      match /completions_english_b1/{document=**} {
        allow read: if request.auth != null && 
                      (request.auth.uid == userId || 
                       request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43");
        allow write: if request.auth != null && request.auth.uid == userId;
      }

      // User completions (English B2)
      match /completions_english_b2/{document=**} {
        allow read: if request.auth != null && 
                      (request.auth.uid == userId || 
                       request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43");
        allow write: if request.auth != null && request.auth.uid == userId;
      }
      
      // User streaks (Daily Streaks feature)
      // Allow users to read/write their own streak data
      // Admin can read all streaks
      match /streaks/{document=**} {
        allow read: if request.auth != null && 
                      (request.auth.uid == userId || 
                       request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43");
        allow write: if request.auth != null && request.auth.uid == userId;
      }

      // User premium status (In-App Purchases)
      // Allow users to read/write their own premium data
      // Admin can read all premium data
      match /premium/{document=**} {
        allow read: if request.auth != null && 
                      (request.auth.uid == userId || 
                       request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43");
        allow write: if request.auth != null && request.auth.uid == userId;
      }

      // User vocabulary progress (German A1)
      match /vocabulary_progress_german_a1/{document=**} {
        allow read: if request.auth != null && 
                      (request.auth.uid == userId || 
                       request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43");
        allow write: if request.auth != null && request.auth.uid == userId;
      }

       // User vocabulary progress (German B1)
      match /vocabulary_progress_german_b1/{document=**} {
        allow read: if request.auth != null && 
                      (request.auth.uid == userId || 
                       request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43");
        allow write: if request.auth != null && request.auth.uid == userId;
      }

      // User vocabulary progress (German B2)
      match /vocabulary_progress_german_b2/{document=**} {
        allow read: if request.auth != null && 
                      (request.auth.uid == userId || 
                       request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43");
        allow write: if request.auth != null && request.auth.uid == userId;
      }

      // User vocabulary progress (English B1)
      match /vocabulary_progress_english_b1/{document=**} {
        allow read: if request.auth != null && 
                      (request.auth.uid == userId || 
                       request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43");
        allow write: if request.auth != null && request.auth.uid == userId;
      }

      // User vocabulary progress (English B2)
      match /vocabulary_progress_english_b2/{document=**} {
        allow read: if request.auth != null && 
                      (request.auth.uid == userId || 
                       request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43");
        allow write: if request.auth != null && request.auth.uid == userId;
      }

      // Exam Prep Plan - Main collection (study plans, assessments, progress)
      match /prep-plan/{document=**} {
        allow read: if request.auth != null && 
                      (request.auth.uid == userId || 
                       request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43");
        allow write: if request.auth != null && request.auth.uid == userId;
      }

      // Speaking practice dialogues and progress (German B1)
      match /speaking-dialogues/{document=**} {
        allow read: if request.auth != null && 
                      (request.auth.uid == userId || 
                       request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43");
        allow write: if request.auth != null && request.auth.uid == userId;
      }

      // Speaking dialogues (German B1)
      match /speaking_dialogues_german_b1/{document=**} {
        allow read: if request.auth != null && 
                      (request.auth.uid == userId || 
                       request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43");
        allow write: if request.auth != null && request.auth.uid == userId;
      }

      // Speaking dialogues (German A1)
      match /speaking_dialogues_german_a1/{document=**} {
        allow read: if request.auth != null && 
                      (request.auth.uid == userId || 
                       request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43");
        allow write: if request.auth != null && request.auth.uid == userId;
      }

      // Speaking dialogues (German B2)
      match /speaking_dialogues_german_b2/{document=**} {
        allow read: if request.auth != null && 
                      (request.auth.uid == userId || 
                       request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43");
        allow write: if request.auth != null && request.auth.uid == userId;
      }

      // Speaking dialogues (English B1)
      match /speaking_dialogues_english_b1/{document=**} {
        allow read: if request.auth != null && 
                      (request.auth.uid == userId || 
                       request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43");
        allow write: if request.auth != null && request.auth.uid == userId;
      }

      // Speaking dialogues (English B2)
      match /speaking_dialogues_english_b2/{document=**} {
        allow read: if request.auth != null && 
                      (request.auth.uid == userId || 
                       request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43");
        allow write: if request.auth != null && request.auth.uid == userId;
      }

      // Speaking turn evaluations
      match /speaking-evaluations/{document=**} {
        allow read: if request.auth != null && 
                      (request.auth.uid == userId || 
                       request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43");
        allow write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // Account deletion requests
    // Users can only read and create their own deletion request
    // Admin can read and update all deletion requests
    match /account_deletion_requests/{userId} {
      allow read: if request.auth != null && 
                    (request.auth.uid == userId || 
                     request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43");
      allow create: if request.auth != null 
                    && request.auth.uid == userId
                    && request.auth.uid == request.resource.data.uid
                    && request.resource.data.status == 'pending';
      allow update: if request.auth != null && 
                      request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43";
    }

    // Issue Reports Collection
    // All users (authenticated and anonymous) can create issue reports
    // Users can read any report (needed because anonymous users store IDs locally)
    // Users can update ONLY their own reports (matched by deviceUUID) to mark as seen
    // Admin can update/delete any report
    match /issueReports/{reportId} {
      allow read: if true; // Allow all users to read reports (they have the document IDs from local storage)
      allow create: if true; // Allow all users to create reports (authenticated and anonymous)
      
      // Allow device owner to update their own report (for marking as seen)
      // Check that deviceUUID matches and only specific fields are being updated
      allow update: if request.resource.data.deviceUUID == resource.data.deviceUUID &&
                       request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['seenByUserAt', 'seenByUserSource', 'deviceUUID']);
      
      // Admin can update and delete any report
      allow update, delete: if request.auth != null && 
                              request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43";
    }

    // User Analytics Collection
    // Only admin can read analytics data
    // Cloud Functions (service account) can write
    match /user_analytics/{appId} {
      allow read: if request.auth != null && 
                    request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43";
      allow write: if false; // Only Cloud Functions can write
      
      // Daily snapshots subcollection
      match /daily_snapshots/{date} {
        allow read: if request.auth != null && 
                      request.auth.uid == "jgOmmKqU1ZYO1KE8NwrqpxiUkn43";
        allow write: if false; // Only Cloud Functions can write
      }
    }
  }
}

