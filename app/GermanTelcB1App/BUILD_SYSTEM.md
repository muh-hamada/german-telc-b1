# Multi-App Build System Documentation

## Overview

This project uses a configuration-driven build system that allows you to build multiple apps (different languages and levels) from a single codebase. Each app has its own:

- App name and display name
- Bundle ID (for Android and iOS)
- Firebase collection names
- Exam-specific translations
- Exam structure configuration

## Quick Start

### Building for German B1 (Default)

```bash
# Build Android app
npm run build:android:german-b1
# or
./build-android.sh german-b1

# Build iOS app
npm run build:ios:german-b1
# or
./build-ios.sh german-b1
```

### Building for Other Exams

```bash
# German B2
npm run build:android:german-b2

# English B1
npm run build:android:english-b1
```

### Configuration Only (No Build)

To apply configuration changes without building:

```bash
npm run config:german-b1:android
# or
./scripts/build-config.sh german-b1 android
```

## Available Exam Configurations

### Currently Configured

1. **german-b1** - German TELC B1 (default)
   - Bundle ID: `com.mhamada.telcb1german`
   - Firebase Collection: `b1_telc_exam_data`

2. **german-b2** - German TELC B2
   - Bundle ID: `com.mhamada.telcb2german`
   - Firebase Collection: `german_b2_exam_data`

3. **english-b1** - English TELC B1
   - Bundle ID: `com.mhamada.telcb1english`
   - Firebase Collection: `english_b1_exam_data`

## How It Works

### 1. Configuration Files

All exam configurations are stored in `src/config/exams/`:

```
src/config/
  ├── exam-config.types.ts          # TypeScript type definitions
  ├── active-exam.config.ts         # Auto-generated by build script
  └── exams/
      ├── index.ts                  # Configuration registry
      ├── german-b1.config.ts       # German B1 configuration
      ├── german-b2.config.ts       # German B2 configuration (future)
      └── english-b1.config.ts      # English B1 configuration (future)
```

### 2. Translation Files

Exam-specific translations are stored separately from UI translations:

```
src/locales/
  ├── en.json, de.json, ar.json... # Base UI translations
  └── exam-content/
      ├── german-b1/
      │   ├── en.json               # German B1 exam strings in English
      │   ├── de.json               # German B1 exam strings in German
      │   └── ...
      ├── german-b2/
      └── english-b1/
```

The i18n system automatically merges base UI translations with exam-specific translations at runtime.

### 3. Build Process

When you run a build command, the following happens:

1. **Configuration Application** (`scripts/apply-exam-config.js`)
   - Updates `app.json` with app name
   - Updates Android `build.gradle` with bundle ID
   - Updates Android `strings.xml` with app name
   - Updates iOS `Info.plist` with bundle ID and display name
   - Generates `src/config/active-exam.config.ts` with selected exam ID

2. **Development Checks** (`check-dev-flags.sh`)
   - Ensures no development flags are enabled in production builds

3. **Build Execution**
   - React Native builds the app with the applied configuration
   - Firebase services use exam-specific collection names
   - UI shows exam-specific translations

## Adding a New Exam Configuration

### Step 1: Create Configuration File

Create a new file `src/config/exams/your-exam.config.ts`:

```typescript
import { ExamConfig } from '../exam-config.types';

export const yourExamConfig: ExamConfig = {
  id: 'your-exam-id',
  language: 'german', // or 'english', 'french', etc.
  level: 'B2',
  
  appName: 'YourAppName',
  displayName: 'Your Display Name',
  bundleId: {
    android: 'com.yourcompany.yourapp',
    ios: 'com.yourcompany.yourapp',
  },
  
  firebaseCollections: {
    examData: 'your_exam_data_collection',
    userProgress: 'users/{uid}/your_exam_progress',
  },
  
  metadata: {
    cefrLevel: 'B2',
    totalDurationMinutes: 180,
    totalMaxPoints: 300,
    passingScore: 180,
  },
  
  features: {
    reading: true,
    listening: true,
    writing: true,
    speaking: true,
    grammar: false, // Disable if not applicable
  },
};
```

### Step 2: Register Configuration

Add your config to `src/config/exams/index.ts`:

```typescript
import { yourExamConfig } from './your-exam.config';

export const EXAM_CONFIGS: Record<string, ExamConfig> = {
  'german-b1': germanB1Config,
  'your-exam-id': yourExamConfig, // Add here
};
```

### Step 3: Update Build Scripts

Add your exam to `scripts/apply-exam-config.js`:

```javascript
const configs = {
  'german-b1': { ... },
  'your-exam-id': { ... }, // Add configuration here
};
```

### Step 4: Add NPM Scripts

Add build scripts to `package.json`:

```json
{
  "scripts": {
    "build:android:your-exam-id": "./build-android.sh your-exam-id",
    "build:ios:your-exam-id": "./build-ios.sh your-exam-id",
    "config:your-exam-id:android": "./scripts/build-config.sh your-exam-id android",
    "config:your-exam-id:ios": "./scripts/build-config.sh your-exam-id ios"
  }
}
```

### Step 5: Create Exam-Specific Translations

Create translation files in `src/locales/exam-content/your-exam-id/`:

```
src/locales/exam-content/your-exam-id/
  ├── en.json
  ├── de.json
  ├── ar.json
  ├── es.json
  ├── fr.json
  └── ru.json
```

Each file should contain exam-specific strings like:

```json
{
  "exam": {
    "name": "Your Exam Name",
    "description": "Your exam description"
  },
  "onboarding": {
    "welcome": "Welcome message for your exam"
  }
}
```

### Step 6: Set Up Firebase Collections

In your Firebase Console:

1. Create a new collection with the name you specified in `firebaseCollections.examData`
2. Structure the documents according to your exam sections:
   - `exam-info`
   - `reading-part1`, `reading-part2`, `reading-part3`
   - `grammar-part1`, `grammar-part2`
   - `listening-part1`, `listening-part2`, `listening-part3`
   - `writing`
   - `speaking-part1`, `speaking-part2`, `speaking-part3`

### Step 7: Test Configuration

Test that the configuration applies correctly:

```bash
npm run config:your-exam-id:android
```

Verify:
- `app.json` has the correct name
- `android/app/build.gradle` has the correct bundle ID
- `src/config/active-exam.config.ts` references your exam ID

### Step 8: Build and Test

Build the app:

```bash
npm run build:android:your-exam-id
```

## Firebase Structure

Each exam uses separate Firebase collections to avoid data conflicts:

```
Firestore:
├── german_b1_exam_data/
│   ├── exam-info
│   ├── reading-part1
│   ├── grammar-part1
│   └── ...
├── german_b2_exam_data/
│   └── ...
├── users/
│   └── {userId}/
│       ├── progress/                    # German B1 progress
│       ├── german_b2_progress/          # German B2 progress
│       └── completions/
│           ├── reading/
│           ├── listening/
│           └── ...
```

## Development Workflow

### During Development

For development, the app uses the default `german-b1` configuration. You can run:

```bash
npm start
npm run android
npm run ios
```

The app will use `process.env.EXAM_ID || 'german-b1'` as the active configuration.

### Switching Configurations During Development

To test a different configuration during development:

1. Apply the configuration:
   ```bash
   npm run config:german-b2:android
   ```

2. Restart Metro bundler and rebuild:
   ```bash
   npm start -- --reset-cache
   npm run android
   ```

### Production Builds

For production, always use the build scripts:

```bash
./build-android.sh german-b1
./build-ios.sh german-b1
```

These scripts ensure the correct configuration is applied before building.

## Troubleshooting

### Build fails with "Exam configuration not found"

Make sure:
1. The exam ID is correctly spelled
2. The configuration is registered in `src/config/exams/index.ts`
3. The configuration is added to `scripts/apply-exam-config.js`

### Translations not showing

Check:
1. Translation files exist in `src/locales/exam-content/{exam-id}/`
2. The i18n configuration in `src/utils/i18n.ts` is loading exam translations
3. Metro bundler cache is cleared: `npm start -- --reset-cache`

### Firebase data not loading

Verify:
1. Collection name in `firebaseCollections.examData` matches Firestore
2. Firebase permissions allow reading from the collection
3. Documents in Firestore have the correct structure

### Bundle ID conflicts

If you get bundle ID conflicts:
1. Ensure each exam has a unique bundle ID in its configuration
2. Check that the bundle ID is updated in both Android and iOS configurations
3. Clean build folders: `cd android && ./gradlew clean`

## Scripts Reference

### Build Scripts

- `./build-android.sh <exam-id>` - Build Android app for specified exam
- `./build-ios.sh <exam-id>` - Build iOS app for specified exam

### Configuration Scripts

- `./scripts/build-config.sh <exam-id> <platform>` - Apply configuration for specified exam and platform
- `./scripts/apply-exam-config.js <exam-id> <platform>` - Node script that applies configuration

### NPM Scripts

- `npm run build:android:<exam-id>` - Build Android app
- `npm run build:ios:<exam-id>` - Build iOS app
- `npm run config:<exam-id>:<platform>` - Apply configuration only

## Architecture Decisions

### Why Separate Apps?

We chose to build separate apps rather than a single app with in-app selection because:

1. **App Store Optimization**: Each app can be optimized for its specific market and keywords
2. **Simpler User Experience**: Users download exactly what they need
3. **Clearer Branding**: Each level/language can have its own identity
4. **Better Analytics**: Easier to track engagement per exam type
5. **Easier Updates**: Can update one exam without affecting others

### Why Configuration-Based?

The configuration-based approach provides:

1. **Single Codebase**: Maintain one codebase for all apps
2. **Type Safety**: TypeScript ensures configurations are correct
3. **Easy Testing**: Can switch configurations quickly during development
4. **Scalability**: Adding new exams is straightforward
5. **Consistency**: All apps share the same core functionality

## Future Enhancements

Potential improvements to the build system:

1. **Automated Testing**: Run tests for each exam configuration in CI/CD
2. **Environment Variables**: Support for .env files per exam
3. **Asset Management**: Exam-specific icons and splash screens
4. **Version Management**: Independent versioning per exam
5. **Build Optimization**: Parallel builds for multiple exams

## Support

For issues or questions about the build system:

1. Check this documentation
2. Review the plan file: `multi-app-build-system.plan.md`
3. Examine example configurations in `src/config/exams/`
4. Test with the provided scripts

---

**Last Updated**: 2024
**Build System Version**: 1.0.0

